# 技术文档 - v0.0.1

**项目名称:** Gemini Chat Index Chrome Extension
**版本:** 0.0.1
**日期:** 2025-07-18

## 1. 架构概述

本插件是一个基于 **Manifest V3** 的标准Chrome扩展，其核心逻辑完全由一个内容脚本（`content.js`）驱动。它被设计为在 `gemini.google.com` 页面上运行，通过直接操作DOM来注入UI并提供功能。

其架构遵循以下原则：
- **最小权限**: 插件本身不请求任何特殊的Chrome权限。
- **DOM注入**: 所有UI元素（图标、弹窗）都由 `content.js` 动态创建并注入到页面的 `<chat-window>` 组件中，以确保相对定位和上下文感知。
- **事件驱动**: 插件的功能由用户交互（点击图标）和DOM变化（新消息出现）驱动。
- **本地依赖**: 所有第三方库（Tippy.js, Popper.js）都打包在插件内部，以遵循目标网站严格的内容安全策略（CSP）。

---

## 2. 文件结构与核心组件

```
.
├── content.js          # 核心逻辑：UI注入、事件处理、DOM监听
├── manifest.json       # 插件清单，定义入口、权限和依赖
├── styles.css          # 主要样式，包括UI布局、主题、自定义Tooltip
├── images
│   └── icon.svg        # 插件图标 (SVG格式)
├── vendor              # 第三方依赖
│   ├── popper.min.js
│   ├── tippy-bundle.umd.min.js
│   └── tippy.css
└── docs                # 项目文档
```

### 2.1 `manifest.json`

- **`manifest_version`**: 3，遵循最新的Chrome扩展标准。
- **`content_scripts`**:
    - `matches`: 指定了插件只在 `https://gemini.google.com/*` 域名下激活。
    - `css`: 注入了 `vendor/tippy.css` 和我们自定义的 `styles.css`。**顺序很重要**，先加载库的CSS，再加载我们自己的覆盖/自定义样式。
    - `js`: 注入了 `popper.min.js`、`tippy-bundle.umd.min.js` 和 `content.js`。**顺序至关重要**，必须先加载依赖库，`content.js` 才能调用它们。

### 2.2 `content.js`

这是插件的“大脑”，负责所有动态行为。

- **初始化流程 (`checkInterval` -> `initializeUI`)**:
    1.  一个 `setInterval` (`checkInterval`) 每500ms轮询一次，直到检测到 `<chat-window>` 元素出现在页面上。
    2.  检测成功后，`clearInterval` 停止轮询，并调用 `initializeUI` 函数来执行一次性的UI注入。
    3.  这种动态检测机制对于处理单页应用（SPA）的延迟加载至关重要。

- **UI创建 (`initializeUI`)**:
    1.  创建入口图标 (`#gemini-entry-icon`) 和隐藏的目录弹窗 (`#gemini-toc-popover`)。
    2.  将 `<chat-window>` 的 `position` 设置为 `relative`（如果它不是），这是确保我们的绝对定位UI能正确定位的关键。
    3.  初始化 **Tippy.js**，为入口图标绑定一个工具提示。

- **目录更新 (`updateTocList`)**:
    1.  清空当前的列表。
    2.  通过 `document.querySelectorAll('user-query')` 获取所有用户提问。
    3.  **文本提取**: 实现了一个健壮的文本提取逻辑，优先尝试 `.message-content` 或 `rich-text-viewer`，如果失败则降级到整个 `<user-query>` 的 `innerText`。
    4.  为每个提问创建一个列表项和按钮，并附加点击事件。

- **交互逻辑 (`showPopover`, `hidePopover`)**:
    - `showPopover` 负责显示弹窗，并注册一个临时的、一次性的全局点击事件，用于在用户点击弹窗外部时调用 `hidePopover`。
    - `hidePopover` 负责隐藏弹窗，并移除全局点击事件监听器。
    - 通过 `e.stopPropagation()` 来防止弹窗内部的点击事件冒泡到 `document`，从而避免了弹窗在点击内部时意外关闭。

- **DOM监听 (`MutationObserver`)**:
    - 这是插件的核心性能保障。它专门监听 `<chat-window>` 的子节点变化。
    - **关键优化**: Observer的回调函数会仔细检查 `mutation.addedNodes`，只有当新增的节点是 `<user-query>` 或 `<model-response>` 元素时，才认为需要更新目录。这避免了因文本流式输出等微小变化导致的频繁重渲染。

### 2.3 `styles.css`

- **CSS变量 (Custom Properties)**:
    - 大量使用CSS变量来定义颜色、阴影等样式，极大地简化了主题切换。
    - 定义了两套变量：一套在 `:root` 中（亮色主题），另一套在 `body.dark-theme, :root[theme=dark]` 选择器下（暗黑主题）。这种方式能自动响应Gemini网站自身的主题切换。
- **SVG图标**:
    - 入口图标通过 `background-image: var(--icon-svg)` 加载。
    - `--icon-svg` 变量的值是一个 **Data URI**，它将 `images/icon.svg` 的内容直接编码到CSS中。这解决了SVG作为DOM元素可能与页面脚本冲突的问题。
- **自定义Tooltip主题**:
    - 通过 `.tippy-box[data-theme~='gemini-tooltip']` 选择器定义了一个名为 `gemini-tooltip` 的自定义Tippy主题，实现了无箭头、简约的视觉效果。

---

## 3. 依赖管理

- **Popper.js (`vendor/popper.min.js`)**: Tippy.js的底层依赖，用于精确定位弹窗和工具提示。
- **Tippy.js (`vendor/tippy-bundle.umd.min.js`)**: 一个功能强大且轻���级的工具提示库。我们用它来实现入口图标的hover提示。选择它的原因是其丰富的API、优美的动画和主题定制能力。

所有依赖均通过本地文件形式打包在 `vendor/` 目录中，以应对目标网站的CSP策略。

---

## 4. 后续开发指引

- **修改UI样式**: 集中在 `styles.css` 中进行。优先考虑修改CSS变量。
- **调整交互逻辑**: 核心交互代码位于 `content.js` 的 `initializeUI`, `showPopover`, `hidePopover` 函数中。
- **修改文本提取规则**: 如果Gemini前端更新了DOM结构，应首先检查 `updateTocList` 函数中的 `querySelectorAll` 和文本提取逻辑。
- **升级依赖**:
    1.  从官方渠道（如unpkg）下载新版本的 `.min.js` 和 `.css` 文件。
    2.  替换 `vendor/` 目录中的旧文件。
    3.  测试以确保没有兼容性问题。
- **调试技巧**:
    - 在Chrome的扩展管理页面（`chrome://extensions`）中，点击本插件的“检查视图”可以打开背景页的控制台（虽然我们没有背景页，但某些错误会在这里显示）。
    - 在Gemini页面上，直接使用F12开发者工具，在“Elements”面板中可以找到我们注入的HTML元素，在“Console”中可以看到 `content.js` 的 `console.log` 输出。
