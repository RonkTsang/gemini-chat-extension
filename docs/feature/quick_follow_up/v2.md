# **产品需求文档 (PRD): “Quick Follow-up” 自定义 Prompt 功能**

| **文档版本** | **V2.0** |
| :--- | :--- |
| **功能名称** | Quick Follow-up 自定义 Prompt (Custom Prompts for Quick Follow-up) |
| **创建日期** | 2025年10月30日 |
| **相关设计** | [v2](./v2.png) |

### 1. 功能概述 (Overview)

“Quick Follow-up” 功能极大地提升了用户在 Gemini 对话中进行追问的效率。为了进一步赋能“超级用户” (Power User)，我们将引入**自定义 Prompt**功能。该功能允许用户创建、管理和使用自己预设的、包含选中内容的追问模板，将重复性工作流自动化，实现更高层次的个性化和效率提升。

### 2. 目标与价值 (Goals & Objectives)

*   **提升用户效率:** 让用户将常用的追问模式（如“翻译”、“解释”、“总结”）一键化，消除重复输入。
*   **增强产品粘性:** 提供深度个性化配置，使用户的插件体验独一无二，从而提高用户留存率。
*   **扩展功能边界:** 将插件从一个“便利工具”升级为一个“可编程的对话工作流引擎”。

### 3. 用户故事 (User Stories)

*   **As a user,** I want to create my own follow-up prompts (e.g., "Translate this to Chinese", "Explain this like I'm five") so that I don't have to type them out every time.
*   **As a user,** I want to assign a unique icon to each custom prompt so I can quickly identify them.
*   **As a user,** I want to reorder my custom prompts so I can place my most frequently used ones first.
*   **As a user,** when I select text in Gemini's response, I want to see my custom prompts alongside the default "Ask Gemini" option.
*   **As a user,** I want to easily enable or disable the entire "Quick Follow-up" feature.

### 4. 功能需求 (Functional Requirements)

#### 4.1. **设置界面 - 主体 (Settings UI - Main)**

1.  **功能总开关 (Master Toggle):**
    *   在插件的 "Quick Follow-up" 设置页面顶部，提供一个名为 "Enable Quick Follow-up" 的总开关。
    *   此开关控制整个划词追问功能的启用与禁用。关闭后，在 Gemini 页面选择文本不会触发任何弹窗。
    *   开关状态需持久化保存。

2.  **自定义 Prompt 区域:**
    *   在总开关下方，设立 "Custom Prompt" 管理区域。
    *   提供一个 `(+)` 添加按钮，用于创建新的自定义 Prompt 卡片。

#### 4.2. **自定义 Prompt 卡片 (Custom Prompt Card)**

点击 `(+)` 按钮后，在列表末尾新增一个可配置的卡片，包含以下组件：

1.  **图标选择器 (Icon Picker):**
    *   **显示:** 卡片左侧为一个图标按钮，默认随机显示一个通用图标（如 `⚙️` 或 `✏️`）。
    *   **交互:** 点击此按钮后，弹出一个 Popover 浮层。
    *   **浮层内容:** 浮层内以网格 (Grid) 形式展示一系列预设的、风格统一的常用图标（如翻译、代码、书籍、灯泡等）。
    *   **选择:** 用户点击 Grid 中的任一图标，Popover 关闭，卡片上的图标更新为所选图标。

2.  **Prompt 名称 (Prompt Name):**
    *   **组件:** 一个 `input` 文本框。
    *   **属性:** 此项为**可选 (Optional)**。
    *   **占位符 (Placeholder):** "Custom Prompt Name (Optional)"。
    *   **用途:** 用于用户内部识别，不会显示在最终的胶囊按钮上。

3.  **Prompt 模板 (Prompt Template):**
    *   **组件:** 一个可编辑的文本区域 (Editable Component)，支持多行输入。
    *   **属性:** 此项为**必填 (Required)**。
    *   **核心变量:** 包含一个不可编辑的占位符 `{{SELECT_TEXT}}`。此占位符在视觉上应有特殊样式（如主题色高亮、不同背景色），以明确告知用户其特殊性。
    *   **默认值:** 新创建的卡片，此字段默认填充 `{{SELECT_TEXT}}`。
    *   **功能:** 用户在此模板中定义的文本，将与 `{{SELECT_TEXT}}`（即用户在 Gemini 页面上实际选择的文本）组合，形成最终发送的 Prompt。

4.  **删除按钮 (Delete Button):**
    *   **显示:** 默认隐藏。当用户的鼠标悬停 (Hover) 在该卡片上时，在右上角浮现一个 `(x)` 关闭/删除按钮。
    *   **交互:** 点击此按钮，该卡片被删除，并触发实时预览的更新。

#### 4.3. **管理自定义 Prompt (Managing Prompts)**

1.  **编辑:** 用户可以随时修改任意卡片的图标、名称和模板内容。所有修改应自动保存。
2.  **排序:** 用户可以通过**拖拽 (Drag and Drop)** 任意一个自定义 Prompt 卡片来调整它们在列表中的顺序。此顺序将直接影响实时预览中图标的排列顺序。

#### 4.4. **实时预览 (Live Preview)**

在自定义 Prompt 区域下方，提供一个“实时预览”模块，模拟并实时展示用户在 Gemini 页面上看到的**胶囊按钮 (Capsule Button)** 的样式。（此组件代码在旧代码中 src/entrypoints/content/lagecy/content.ts, 需要新建react组件进行复刻）

1.  **固定按钮:**
    *   预览的胶囊按钮**始终以固定的 "Ask Gemini" 按钮开始**。此按钮对应最基础的追问功能（仅将选中内容填入输入框，不加任何额外文本）。

2.  **自定义按钮:**
    *   根据用户创建和排序的自定义 Prompt，**依次在 "Ask Gemini" 按钮后添加对应的图标**。
    *   **显示上限:** 最多直接显示 **3** 个自定义图标。
    *   **溢出处理:** 如果自定义 Prompt 数量超过 3 个，则第 3 个图标的位置被一个 `(>)` 箭头图标替代。
    *   **交互 (实际功能，非预览):**
        *   点击 `(>)` 箭头，会展开一个包含所有自定义 Prompt 图标的浮层或列表。
        *   点击任意一个自定义图标，会执行对应的 Prompt 模板，将组合后的文本填入 Gemini 输入框并**聚焦 (focus)**。

#### 4.5. **数据持久化 (Data Persistence)**

*   所有设置，包括总开关状态、自定义 Prompt 的内容（图标、名称、模板）及其顺序，必须使用 项目中存储方案（@src/data） 进行持久化保存。

*   同时，需要新建 Store 并将 custom prompt 的数据及时更新至 Store 中，以驱动 UI 的更新

#### 4.6. **Quick Follow-up 生效**
在 @src/entrypoints/content/lagecy/content.ts 中的 quick follow-up 需要实时感知custom prompt的更新，并在用户完成划词弹出的胶囊按钮中展示 custom prompt，样式同“上述4.4实时预览”，展示布局为 [ask Gemini | CustomPromptIcon1 CustomPromptIcon2 >(如有更多)]，参考[设计稿](./v2.png) 中的胶囊按钮样式与交互。

详细交互：
- 当用户鼠标hover至“ask Gemini”或“CustomPromptIcon”，按钮会有背景色的微小变化
- 当用户鼠标 hover 至 “CustomPromptIcon” 时，出现 tooltips 展示 custom Prompt 的 name 属性
- 当用户点击“ask Gemini”，维持原逻辑不变
- 当用户点击 “CustomPromptIcon”，获取对应 Custom prompt，并将prompt 中的 “{{SELECT_TEXT}}” 填充为选中的文本，最后使用 [editorUtils](@src/utils/editorUtils.ts) 将完成填充处理的 prompt 文本帮忙用户完成 **自动发送**


### 5. 非功能性需求 (Non-Functional Requirements)

*   **性能:** 所有在 Gemini 页面的 DOM 操作和事件监听都必须是高效的，不能对 Gemini 页面的性能产生可感知的负面影响。
*   **易用性:** 界面交互应直观、流畅。特别是拖拽排序和图标选择，应有即时的视觉反馈。
*   **数据校验:** Prompt 模板字段不能为空。如果用户清空了此字段，应有视觉提示（如红色边框）并阻止保存一个无效的 Prompt。
