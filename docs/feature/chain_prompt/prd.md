# **产品需求文档：Chain Prompt 功能 (V1)**

#### **1. 整体目标 (Objective)**

在 Setting Panel 中为用户提供一个强大而直观的界面，用于创建、管理和执行由多个步骤组成的“链式提示词”（Chain Prompt）。用户能够将复杂任务分解为有序的步骤，并通过变量实现模板化，从而极大地提升与Gemini交互的效率和可复用性。

#### **2. 核心用户故事 (Core User Stories)**

*   **创建与复用:** “作为一名内容创作者，我希望能保存一个‘博客文章生成’流程（生成标题 -> 生成大纲 -> 写引言 -> 写正文），这样我每次写新主题时，只需输入主题就能一键启动，而无需重复输入指令。”
*   **管理与查找:** “作为一名开发者，我保存了很多用于代码重构和调试的Chain Prompts，我希望能快速地找到、复制或删除它们。”
*   **执行与交互:** “作为一名营销人员，我希望能运行一个‘社交媒体帖子生成’的Chain，在开始时输入‘产品名称’和‘目标平台’，然后让它自动完成后续步骤。”

#### **3. 数据模型 (Data Model)**

在开始设计前，我们先定义一个Chain Prompt对象的基础结构：

```json
{
  "id": "unique-string-123",
  "name": "博客文章生成器",
  "description": "输入一个主题，自动完成标题、大纲和引言的撰写。",
  "createdAt": "iso-timestamp",
  "variables": [
    { "key": "TOPIC", "defaultValue": "AI的未来" },
    { "key": "TONE", "defaultValue": "专业且通俗易懂" }
  ],
  "steps": [
    { "id": "step-1", name: "话题标题初稿", "prompt": "为关于“{{TOPIC}}”的博客文章生成5个吸引人的标题。" },
    { "id": "step-2", name: "大纲生成",  "prompt": "从以下标题中选择最好的一个，并为其生成详细的写作大纲。\n\n标题列表：\n{{Step1.output}}" }
  ]
}
```

---

### **页面1: Chain Prompt 列表页**

这是用户管理所有Chain Prompts的仪表盘。

#### **UI & 组件设计**

1.  **页面标题:** 顶部是一个清晰的大标题：“Chain Prompt”。
2.  **主操作按钮:** 标题右侧是一个显眼的“+ New Chain Prompt”按钮，使用品牌主色调。
3.  **搜索/筛选栏 (V1.5 可选):** 在标题下方，提供一个搜索框，允许用户根据`name`或`description`快速筛选列表。
4.  **Prompt 卡片列表:**
    *   主体区域以卡片（Card）网格或列表的形式展示所有已保存的Chain Prompts。
    *   **卡片内容:**
        *   **名称 (Name):** 粗体、突出的标题。
        *   **描述 (Description):** 灰色、较小字号的辅助性文本，最多显示2-3行，超出部分用“...”省略。
        *   **信息栏:** 卡片底部可以展示一些元信息，如“创建日期”或“包含X个步骤”。
    *   **卡片上的交互元素:**
        *   **“Run”按钮:** 一个非常显眼的“运行”按钮（例如，带有一个播放图标 `►`），用于快速执行。
        *   **“更多”菜单 (`...`):** 卡片右上角有一个“更多”操作的下拉菜单（Kebab Menu）。

#### **功能需求**

1.  **显示:** 默认加载并显示用户所有已保存的Chain Prompts。
2.  **创建:** 点击“+ New Chain Prompt”按钮，导航至“编辑页”并处于新建模式。
3.  **执行:** 点击任一卡片上的“Run”按钮，触发执行流程。
4.  **编辑:** 在“更多”菜单中，提供“Edit”选项，点击后导航至“编辑页”并载入该Prompt的数据。
5.  **复制:** 在“更多”菜单中，提供“Copy”选项，点击后会创建一个完全相同的副本，新名称默认为“（原名称） Copy”，并立即导航到这个新副本的编辑页面。
6.  **删除:** 在“更多”菜单中，提供“Delete”选项。

#### **用户交互流程**

*   **执行流程:**
    1.  用户点击“Run”按钮。
    2.  如果该Chain Prompt定义了`variables`，则弹出一个Modal窗口。
    3.  Modal中会列出所有变量的`key`，并提供输入框让用户填写本次运行的值（输入框中可预填`defaultValue`）。
    4.  用户填写完毕后，点击Modal中的“Execute”按钮，开始在后台执行。
    5.  （执行反馈待后续设计，初期可以简单提示“已开始执行”）。
*   **删除流程:**
    1.  用户点击“Delete”选项。
    2.  弹出一个确认对话框（Alert Dialog），提示“您确定要删除‘[Prompt名称]’吗？此操作无法撤销。”
    3.  用户点击“确认删除”后，该卡片从列表中移除。

---

### **页面2: Chain Prompt 编辑/新建页**

这是功能的核心，用户在此定义Chain的每一个细节。

#### **UI & 组件设计**

1.  **页面布局:** 采用二级页面的设计，有清晰的“← Back”返回按钮（ContentArea组件已有）。
2.  **名称与描述:**
    *   页面顶部是一个大尺寸的输入框，用于填写`name`（必填）。
    *   下方是一个多行文本域（Textarea），用于填写`description`（可选）。
3.  **变量定义区:**
    *   一个可折叠的区域，标题为“输入变量 (Input Variables)”。
    *   内部是一个“键-值”对列表。每一行包含两个输入框，分别用于`key`和`defaultValue`，以及一个删除按钮。
    *   底部有一个“+ Add variable”按钮。
4.  **步骤编排区:**
    *   这是页面的核心，采用我们决定的**“清单模式”**。
    *   标题为“步骤 (Steps)”。
    *   **步骤项:** 每一个步骤都是一个独立的UI单元，包含：
        *   **步骤编号:** 左侧显示一个醒目的数字（1, 2, 3...）。
        *   **拖拽手柄 (`⋮⋮`):** 允许用户按住并上下拖动以重新排序。
        *   **Prompt 输入框:** 一个可自适应高度的多行文本域，用于编写该步骤的Prompt。
        *   **变量插入助手:** 在输入框下方或旁边，提供一个“插入...”按钮/下拉菜单。点击后可选择所有已定义的“输入变量”（如 `{{TOPIC}}`）和之前步骤的输出（如 `{{Step1.output}}`），方便用户一键插入。
        *   **删除按钮:** 用于删除该步骤。
    *   **添加步骤按钮:** 在整个列表的底部，有一个清晰的“+ Add step”按钮。
5.  **操作栏:**
    *   页面底部或右上角有一个固定的操作栏，包含一个主操作按钮“Save”和一个次操作按钮“Cancel”。

#### **功能需求**

1.  **数据绑定:**
    *   如果是“编辑”模式，所有输入框和步骤列表需正确填充传入的Chain Prompt数据。
    *   如果是“新建”模式，所有字段为空。
2.  **变量管理:** 用户可以自由地添加、删除和编辑输入变量。变量的`key`在同一个Prompt内应是唯一的。
3.  **步骤管理:**
    *   用户可以添加新步骤，新步骤自动添加到列表末尾。
    *   用户可以编辑任意步骤的Prompt文本。
    *   用户可以删除任意步骤。
    *   用户可以通过拖拽手柄**重新排序**步骤。当排序发生变化时，步骤编号应自动更新。
4.  **变量使用:**
    *   在Prompt文本中，系统需要能识别 `{{variableKey}}` 和 `{{StepN.output}}` 格式的变量。
    *   “变量插入助手”需要智能地只显示当前步骤可用的变量（例如，在第3步，只能引用`Step1.output`和`Step2.output`）。
5.  **保存:** 点击“Save”按钮，将当前页面的所有数据（名称、描述、变量、步骤及其顺序）构造成一个Chain Prompt对象，并通过Repository层进行保存（新建或更新）。保存成功后，自动导航回“列表页”。

#### **用户交互流程**

*   **构建一个新Chain:**
    1.  用户进入页面，填写`name`为“周报生成器”。
    2.  在变量区，添加一个`key`为`PROJECT_UPDATES`的变量。
    3.  在步骤区，点击“+ Add step”，添加第一步：`“请将以下工作要点整理成一段通顺的周报段落：{{PROJECT_UPDATES}}”`。
    4.  添加第二步：`“请将以下段落翻译成英文：\n{{Step1.output}}”`。
    5.  点击“Save”，返回列表页，可以看到新的“周报生成器”卡片。
*   **重新排序:**
    1.  用户认为应该先翻译再总结。
    2.  他按住第2步的拖拽手柄，将其拖动到第1步的上方。
    3.  列表顺序立即更新，原来的第2步现在显示编号“1”，原来的第1步显示编号“2”。
    4.  系统后台的数据模型（数组顺序）也同步更新。用户修改Prompt文本中的引用（从`{{Step1.output}}`改为`{{Step2.output}}`等）。
    5.  点击“Save”保存更改。


### **重点：执行 Chain Prompt**
1. 如果被执行 Chain Prompt 定义了 `variables`，则需弹出一个 Modal 窗口。
2. Modal 窗口分为左右两个部分
    - 左边：Modal中会列出所有变量的`key`，并提供输入框让用户填写本次运行的值（输入框中可预填`defaultValue`）。
    - 右边：预览填充后的完整 prompt 文本
3. 如何执行：
    3.1 使用 `src/utils/editorUtils.ts` 的工具函数
    3.2 向输入框插入steps中的第一段 prompt，然后发送第一段消息
    3.3 等待模型完成结果返回
    3.4 检查是否还有下一步 prompt，若有，重复 3.2 步骤

 