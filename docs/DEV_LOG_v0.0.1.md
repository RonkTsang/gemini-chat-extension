# 研发记录文档 - v0.0.1

**项目名称:** Gemini Chat Index Chrome Extension
**版本:** 0.0.1
**日期:** 2025-07-18
**作者:** Gemini

## 1. 项目概述

本项目旨在为 `gemini.google.com` 页面开发一款 Chrome 插件。其核心功能是在页面中生成一个当前对话历史的浮动目录（TOC），以解决在长对话中难以定位和导航的问题。用户通过点击目录中的条目，可以平滑滚动到对应的聊天位置。

最终实现的核心特性包括：
- **动态内容生成**: 插件能够动态监测并提取用户提问（`<user-query>`）作为目录标题。
- **Notion风格UI**: 采用简约的图标入口，点击后以下拉菜单（Popover）形式展示目录，风格与Notion类似。
- **智能交互**: 目录弹窗在点击外部区域后会自动关闭，点击目录项会跳转并关闭弹窗。
- **优雅的Tooltips**: 为入口图标增加了使用 `tippy.js` 实现的、带动画效果的工具提示。
- **亮/暗黑主题自适应**: UI风格（目录、图标、Tooltips）能自动匹配Gemini网站的亮色与暗黑主题。

## 2. 迭代与实现过程

### 第一阶段: 初版实现 (侧边栏面板)
- **目标**: 快速验证核心功能。
- **实现**:
    - 创建了 `manifest.json`, `content.js`, `styles.css` 基础文件结构。
    - UI以一个固定在页面左侧的侧边栏形式存在。
    - 实现了基本的目录生成、点击滚动、展开/收起功能，并支持了亮/暗黑主题。

### 第二阶段: UI简约化 (内嵌式面板)
- **用户反馈**: 希望设计更加简约，入口仅需一个图标，且组件应内嵌于 `<chat-window>`。
- **实现**:
    - **入口改造**: 将固定面板改为一个绝对定位于 `<chat-window>` 左上角的SVG图标。
    - **面板改造**: 点击图标后，在原位展开一个内嵌的索引面板，面板包含关闭按钮。
    - **动态检测**: 增强了脚本，使其能动态等待并检测到 `<chat-window>` 标签出现后再注入UI，提高了插件的健壮性。

### 第三阶段: Notion风格改造 (Popover弹窗)
- **用户反馈**: 希望UI风格进一步向Notion的TOC看齐，更加精致。
- **实现**:
    - **UI重构**: 将内嵌面板改为一个Popover弹窗，点击图标后在图标下方弹出。
    - **交互优化**: 弹窗在点击页面任何其他位置后会自动关闭，交互更自然。
    - **样式优化**: 重新设计了CSS，实现了更简约的��窗样式、阴影和列表项，去除了不必要的边框和背景。
    - **图标定制**: 根据用户要求，定制了新的三条横线递减的Notion风格SVG图标。

### 第四阶段: 体验优化与问题修复
- **用户反馈**: 增加了Tooltips，并修复了若干关键Bug。
- **实现**:
    - **Tooltips**: 引入 `tippy.js` 库，为入口图标增加了优雅的、无箭头的自定义主题工具提示。
    - **关键问题修复**: 解决了内容安全策略（CSP）、列表反复刷新等核心问题（详见下一章节）。

## 3. 关键技术决策与挑战

### 挑战1: 列表反复刷新
- **问题**: 在模型回复（流式输出）时，目录列表会疯狂刷新。
- **原因**: `MutationObserver` 的配置过于宽泛，监听了子树的所有变动，包括文本节点的增删。
- **解决方案**: 优化 `MutationObserver` 的回调逻辑，精确判断 `mutation.addedNodes` 中是否真实包含了 `<user-query>` 或 `<model-response>` 元素节点。只有在这些关键节点出现时，才触发一次列表刷新，从而解决了性能问题。

### 挑战2: 内容安全策略 (CSP) 冲突
- **问题**: 在尝试从CDN动态注入 `tippy.js` 库时，浏览器控制台报错，提示违反了CSP。
- **原因**: Gemini网站的CSP策略禁止加载来自未知域（如 `unpkg.com`）的脚本。
- **解决方案**: 放弃动态加载CDN脚本的方案。采用最稳妥的工程实践：将 `tippy.js` 和 `popper.js` 的库文件下载到本地，存放在 `vendor` 目录中。然后通过 `manifest.json` 的 `content_scripts` 将这些本地脚本注入页面。这确保了所有代码均来自插件本身，完全符合CSP要求。

### 挑战3: SVG图标与页面脚本冲突
- **问题**: 直接向页面注入SVG代码作为入口图标时，导致页面原有脚本报错 (`e.className.match is not a function`)。
- **原因**: 页面脚本可能在遍历DOM并试图读取 `className` 字符串，但SVG元素的 `className` 属性是一个 `SVGAnimatedString` 对象，导致类型不匹配而出错。
- **解决方案**: 避免直接注入 `<svg>` 标签。将入口图标改为一个普通的 `<div>` 元素，然后通过CSS的 `background-image` 属性，使用Data URI的方式将SVG作为背景图像加载。这成功地将SVG与页面的JS环境隔离开来。

### 挑战4: 文本提取不准确
- **问题**: 在某次重构后，无法正确提取用户提问的文本。
- **原因**: 最初的文本提取逻辑 `messageContent.innerText || query.innerText` 是健壮的，它包含了一个降级策略。在重构中，这个降级策略被意外移除。
- **解决方案**: 恢��了这个多层级的文本提取逻辑，确保即使在DOM结构变化时也能稳定地获取到正确的标题。

## 4. 最终项目结构

```
.
├── .env
├── .gitignore
├── README.md
├── content.js
├── docs
│   ├── DEV_LOG_v0.0.1.md
│   └── v0.0.1.md
├── images
│   └── icon.svg
├── manifest.json
├── styles.css
└── vendor
    ├── popper.min.js
    ├── tippy-bundle.umd.min.js
    └── tippy.css
```

## 5. 后续可优化方向
- 提供一个设置页面，允许用户自定义图标位置、弹窗样式等。
- 记忆弹窗的打开/关闭状态。
- 当页面滚动时，在目录中高亮当前视口内对应的条目。
